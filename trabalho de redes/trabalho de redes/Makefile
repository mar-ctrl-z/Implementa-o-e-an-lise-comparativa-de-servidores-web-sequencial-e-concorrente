# Makefile para Projeto de Servidor Web Sequencial e Concorrente
# Aluno: Marina Conrado Moreira Santos
# MatrÃ­cula: 20229035217

.PHONY: help test test-all test-seq test-conc analyze report clean start stop status logs

PYTHON=python3
DOCKER_COMPOSE=docker-compose

help: ## Mostra ajuda
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘     MAKEFILE - Servidor Web Sequencial        â•‘"
	@echo "â•‘     Marina Santos - 20229035217               â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@echo "ğŸ”§ CONFIGURAÃ‡ÃƒO INICIAL:"
	@echo "  make setup      - Configura ambiente (primeira vez)"
	@echo "  make build      - Builda imagens Docker"
	@echo "  make rebuild    - Rebuild completo (limpa + build)"
	@echo ""
	@echo "ğŸ‹ GERENCIAMENTO DOCKER:"
	@echo "  make start      - Inicia servidores"
	@echo "  make stop       - Para servidores"
	@echo "  make restart    - Reinicia servidores"
	@echo "  make status     - Status dos containers"
	@echo "  make logs       - Ver logs"
	@echo ""
	@echo "ğŸ§ª TESTES:"
	@echo "  make test       - Teste rÃ¡pido"
	@echo "  make test-all   - Bateria completa de testes"
	@echo "  make test-seq   - Testa servidor sequencial"
	@echo "  make test-conc  - Testa servidor concorrente"
	@echo ""
	@echo "ğŸ“Š ANÃLISE:"
	@echo "  make analyze    - Gera anÃ¡lise estatÃ­stica"
	@echo "  make report     - Gera template relatÃ³rio"
	@echo "  make info       - InformaÃ§Ãµes do projeto"
	@echo "  make check      - Verifica conectividade"
	@echo ""
	@echo "ğŸ§¹ LIMPEZA:"
	@echo "  make clean      - Limpa arquivos temporÃ¡rios"
	@echo "  make clean-all  - Limpa tudo (incluindo Docker)"
	@echo ""

setup: ## Configura ambiente (primeira vez)
	@echo "ğŸ”§ Configurando ambiente..."
	@echo ""
	@echo "ğŸ“‹ Verificando Docker..."
	@docker --version || (echo "âŒ Docker nÃ£o instalado!" && exit 1)
	@$(DOCKER_COMPOSE) --version || (echo "âŒ Docker Compose nÃ£o instalado!" && exit 1)
	@echo "âœ… Docker OK"
	@echo ""
	@echo "ğŸ“‹ Verificando Python..."
	@$(PYTHON) --version || (echo "âŒ Python 3 nÃ£o instalado!" && exit 1)
	@echo "âœ… Python OK"
	@echo ""
	@echo "ğŸ“‹ Criando diretÃ³rios..."
	@mkdir -p results logs docs/relatorio
	@echo "âœ… DiretÃ³rios criados"
	@echo ""
	@echo "âœ… Setup completo! PrÃ³ximo passo: make build"

build: ## Builda imagens Docker
	@echo "ğŸ”¨ Construindo imagens Docker..."
	@echo ""
	@$(DOCKER_COMPOSE) build --no-cache
	@echo ""
	@echo "âœ… Imagens construÃ­das com sucesso!"
	@echo "ğŸ’¡ PrÃ³ximo passo: make start"

rebuild: stop clean-docker build ## Rebuild completo

clean-docker: ## Limpa recursos Docker
	@echo "ğŸ‹ Limpando recursos Docker..."
	@$(DOCKER_COMPOSE) down -v --remove-orphans 2>/dev/null || true
	@docker image prune -f 2>/dev/null || true
	@echo "âœ… Docker limpo!"

test: ## Teste rÃ¡pido
	@echo "ğŸ§ª Testando servidor SEQUENCIAL..."
	@$(PYTHON) client/test_client.py light_fast sequential
	@echo ""
	@echo "ğŸ§ª Testando servidor CONCORRENTE..."
	@$(PYTHON) client/test_client.py light_fast concurrent

test-seq: ## Testa servidor sequencial
	@$(PYTHON) client/test_client.py light_fast sequential

test-conc: ## Testa servidor concorrente
	@$(PYTHON) client/test_client.py light_fast concurrent

test-all: ## Bateria completa de testes
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  ğŸ§ª BATERIA COMPLETA DE TESTES                â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@mkdir -p results
	@echo "ğŸ“Š Executando testes no servidor SEQUENCIAL..."
	@for scenario in light_fast light_slow medium_mixed heavy_fast heavy_slow; do \
		echo "  â†’ CenÃ¡rio: $$scenario"; \
		$(PYTHON) client/test_client.py $$scenario sequential results/seq_$$scenario.json || true; \
	done
	@echo ""
	@echo "ğŸ“Š Executando testes no servidor CONCORRENTE..."
	@for scenario in light_fast light_slow medium_mixed heavy_fast heavy_slow; do \
		echo "  â†’ CenÃ¡rio: $$scenario"; \
		$(PYTHON) client/test_client.py $$scenario concurrent results/conc_$$scenario.json || true; \
	done
	@echo ""
	@echo "âœ… Bateria de testes concluÃ­da!"
	@echo "ğŸ’¡ Use 'make analyze' para gerar anÃ¡lise"

analyze: ## Gera anÃ¡lise estatÃ­stica
	@echo "ğŸ“ˆ Gerando anÃ¡lise estatÃ­stica..."
	@$(PYTHON) scripts/analyze_results.py
	@echo "âœ… AnÃ¡lise concluÃ­da! Verifique results/"

report: ## Gera template do relatÃ³rio SBC
	@echo "ğŸ“„ Gerando template do relatÃ³rio..."
	@$(PYTHON) scripts/generate_report_template.py
	@echo "âœ… Template gerado em docs/relatorio/"

start: ## Inicia servidores
	@echo "â–¶ï¸  Iniciando servidores..."
	@$(DOCKER_COMPOSE) up -d server server_concurrent
	@sleep 2
	@make status

stop: ## Para servidores
	@echo "â¹ï¸  Parando servidores..."
	@$(DOCKER_COMPOSE) down

restart: stop start ## Reinicia servidores

status: ## Status dos containers
	@echo ""
	@echo "ğŸ“Š STATUS DOS CONTAINERS:"
	@$(DOCKER_COMPOSE) ps
	@echo ""

logs: ## Ver logs
	@$(DOCKER_COMPOSE) logs -f server server_concurrent

logs-seq: ## Logs sequencial
	@$(DOCKER_COMPOSE) logs -f server

logs-conc: ## Logs concorrente
	@$(DOCKER_COMPOSE) logs -f server_concurrent

clean: ## Limpa arquivos temporÃ¡rios
	@echo "ğŸ§¹ Limpando..."
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@echo "âœ… Limpeza concluÃ­da!"

clean-results: ## Remove resultados
	@echo "ğŸ—‘ï¸  Removendo resultados..."
	@rm -rf results/*.json results/*.csv results/*.png 2>/dev/null || true
	@echo "âœ… Resultados removidos!"

clean-all: clean clean-docker ## Limpa tudo (arquivos + Docker)
	@echo "âœ… Limpeza completa concluÃ­da!"

info: ## InformaÃ§Ãµes do projeto
	@echo ""
	@echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
	@echo "â•‘  â„¹ï¸  INFORMAÃ‡Ã•ES DO PROJETO                   â•‘"
	@echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
	@echo ""
	@$(PYTHON) -c "from config import MATRICULA, NOME_ALUNO; print(f'ğŸ‘¤ Aluno: {NOME_ALUNO}'); print(f'ğŸ“ MatrÃ­cula: {MATRICULA}')"
	@echo ""
	@$(PYTHON) -c "from core.crypto_utils import gerar_custom_id; print(f'ğŸ” X-Custom-ID: {gerar_custom_id()}')"
	@echo ""
	@echo "ğŸ“Š Portas:"
	@echo "  â€¢ Servidor Sequencial: 80"
	@echo "  â€¢ Servidor Concorrente: 8080"
	@echo ""

check: ## Verifica conectividade
	@echo "âœ… Verificando servidores..."
	@echo ""
	@echo "ğŸ” Servidor SEQUENCIAL (porta 80):"
	@curl -s http://localhost:80/ -H "X-Custom-ID: $$($(PYTHON) -c 'from core.crypto_utils import gerar_custom_id; print(gerar_custom_id())')" | head -5 || echo "âŒ NÃ£o respondeu"
	@echo ""
	@echo "ğŸ” Servidor CONCORRENTE (porta 8080):"
	@curl -s http://localhost:8080/ -H "X-Custom-ID: $$($(PYTHON) -c 'from core.crypto_utils import gerar_custom_id; print(gerar_custom_id())')" | head -5 || echo "âŒ NÃ£o respondeu"
	@echo ""

.DEFAULT_GOAL := help

